---
layout: post
title:  "CinemaCast"
info: "영화예매사이트"
tech : "Java, Spring Boot, Spring Data JPA, Spring Security, MySQL"
type: Collaboration
---

# 📌 Cinemacast
"cinema"와 "broadcast"의 결합으로 영화를 브로드캐스팅하여 사용자에게 최신 영화 정보와 편리한 예매 서비스를 제공합니다.

## 🖥️ 프로젝트 소개
스프링 부트를 이용해 다양한 영화관 사이트를 참고하여 만든 영화 예매 사이트입니다.

## 📄 프로젝트 발표 자료
- 발표 자료는 [여기에서 다운로드할 수 있습니다](파일_경로/발표자료.pdf).

## 👨‍👩‍👦 프로젝트 구성원
- **팀장**: 김소연 - 회원가입, 로그인, 관리자, 결제 페이지
- **팀원1**: 조혜령 - 기획서 작성, 퍼블리싱, 좌석 선택, 상영시간표
- **팀원2**: 김우영 - TMDB.API를 이용한 페이지
- **팀원3**: 이병훈 - TMDB.API를 이용한 페이지, 고객센터

## ⚙️ 사용된 기술
JAVA, MYSQL, JPA, Spring Framework, CSS3, HTML5, BOOTSTRAP, JAVASCRIPT, JQUERY

# 💡 수행업무

## 메인 페이지
- TMDB API를 호출하여 인기순위, 상영작, 개봉예정작 및 비디오 데이터를 처리하여 영화 정보를 제공

## 영화 상세페이지
 - TMDB API를 호출하여 영화의 상세 내용을 동적으로 로드하여 사용자에게 제공.
 - 사용자가 영화에 대한 평점을 주고 리뷰를 작성할 수 있는 폼을 구현
 - 영화 정보를 카카오톡으로 공유기능

## 고객센터
-  Naver SMTP를 이용하여 사용자 문의 내용을 관리자에게 전송
-  실시간 통신을 위한 WebSocket을 사용하여, 사용자와 관리자가 즉시 메시지를 주고받을 수 있도록 개발.

## 공지사항, 이벤트
- 기본적인 CRUD작업

## 관리자 페이지
- 아이디: 1@admin.com 비밀번호: adminpw
- 이벤트, 공지사항 CRUD작업
- 1대 1 채팅, 문의 답변

## 📞 1:1 채팅 문의
- **문의 방법**
    - 카테고리 선택: 사용자가 문의하고자 하는 카테고리를 선택합니다.
        - 예를 들어, "예매" 카테고리를 선택하면 해당 카테고리에 지정된 관리자에게 문의가 전송됩니다. 이 경우, 문의는 1@admin.com으로 전달됩니다.
        - 예매: 1@admin.com, 판매: 2@admin.com, 행사: 3@admin.com, 기타: 4@admin.com
- **다양한 로그인 방식**
    - 사용자는 일반 사용자 계정으로 로그인한 상태에서 문의를 진행할 수 있습니다. 이때, 일반 사용자는 고객센터에서 카테고리를 선택하고 메시지를 작성합니다.
    - 동시에 관리자는 다른 브라우저에서 카테고리에 맞는 계정으로 로그인하여 어드민 페이지를 열어 놓습니다. 사용자가 선택한 카테고리에 따라 해당 관리자에게 메시지가 전달됩니다.

## 📧 이메일 기능 설정
- **구성 편집**: 이메일 기능을 사용하기 위해 환경변수로 네이버 아이디와 비밀번호를 설정해야 합니다.
    - `adminPassword= ; adminEmail=`

## 🚫 소셜 로그인
- client-id, client-secret와 같은 민감한 정보가 포함되어 있어서 보안상의 이유로 소셜 로그인은 비활성화했습니다.
- 클라이언트 ID 및 비밀번호 누락: 소셜 로그인 기능을 활성화하기 위해 필요한 client-id와 client-secret 설정이 없습니다.

## 📊 데이터 관리
- **영화 데이터**: 외부 API를 통해 자동으로 가져오므로, 별도로 관리자가 생성할 필요는 없습니다.
- **예매, 스낵, 이벤트, 공지사항**: 이러한 데이터는 관리자가 직접 등록해야 하며, 관련 기능은 관리자 페이지에서 처리할 수 있습니다.
- **1:1 채팅 이메일 문의**: 사용자가 문의를 하면 해당 내용이 관리자 페이지에 표시됩니다. 관리자는 이를 통해 사용자와 소통할 수 있습니다.

### 트러블슈팅: 연관 관계 컬렉션 필드 미초기화와 트랜잭션 관리 부족으로 발생한 문제 해결

### 문제 상황

영화 데이터 저장할 때 TMDB API로부터 받은 여러 데이터를 JPA를 통해 저장하는 과정에서 문제가 발생했습니다. 특히, Movie 엔티티와 Genre엔티티 간의 연관 관계를 설정할 때
genres필드가 초기화되지 않았고, DTO를 엔티티로 변환할 때 컬렉션 필드의 초기화가 이루어지지 않았으며, 트랜잭션 관리가 부족한 상황이었습니다. 이로 인해 데이터 저장 작업 중간에 예외가 발생하면 일부 데이터만 저장되고 나머지는 저장되지 않는 문제와 함께, 연관된 컬렉션이 제대로 처리되지 않아 데이터 무결성이 깨졌습니다.

### 원인 분석

1. **컬렉션 필드 미초기화**
    - genres필드가 초기화되지 않아 NullPointerException이 발생했습니다. 컬렉션 필드가 초기화되지 않으면, JPA가 연관된 엔티티들을 적절히 관리하지 못하게 됩니다. 이로 인해 데이터 추가 작업이 실패하고, 엔티티 간의 연관 관계가 올바르게 처리되지 않았습니다.
2. **DTO에서 엔티티 변환 시 필드 초기화 부족**
    - DTO를 엔티티로 변환할 때, 엔티티의 컬렉션 필드가 초기화되지 않아, 변환된 엔티티에서 해당 컬렉션에 데이터를 추가할 때 문제가 발생할 수 있습니다. 이로 인해 초기 상태의 컬렉션에 데이터를 추가할 수 없거나, 예상치 못한 예외가 발생할 수 있습니다.
3. **트랜잭션 관리 부족**
    - 트랜잭션을 적용하지 않아, 작업 도중 예외가 발생하면 이미 저장된 데이터가 롤백되지 않아 데이터의 일관성이 깨졌습니다. 트랜잭션이 없으면 일부 데이터만 저장되고 나머지는 저장되지 않아 데이터의 무결성이 손상되었습니다.
   
# 🛠️ 트러블슈팅 내용

## 문제 상황

1. Member와  Genre간의 관계를 설정할 때, genres필드가 초기화되지 않았습니다. 이로 인해 연관된 Genre엔티티를 추가할 때 예외가 발생했습니다.
2. DTO를 엔티티로 변환할 때, 컬렉션 필드가 초기화되지 않아 변환된 엔티티에서 데이터를 추가하는 과정에서 문제가 발생했습니다.
3. 트랜잭션 관리가 부족하여, 영화, 감독, 배우 데이터를 저장할 때 일부 데이터만 저장되고 나머지는 저장되지 않았습니다.
4. 이로 인해 데이터베이스에 저장된 데이터의 일관성이 깨졌고, 데이터의 무결성이 손상되었습니다.

## 해결 방안

1. **컬렉션 필드 초기화**

   연관 관계 컬렉션 필드를 초기화하여 데이터 추가 작업을 안전하게 처리할 수 있습니다. 이를 통해 NullPointerException 문제를 예방하고, 연관된 엔티티가 올바르게 관리되도록 합니다.

2. **DTO에서 엔티티 변환 시 필드 초기화**

   DTO를 엔티티로 변환할 때, 엔티티의 컬렉션 필드를 초기화하여 변환된 엔티티가 정상적으로 데이터를 추가할 수 있도록 합니다. 이를 통해 엔티티 생성 시 컬렉션 필드가 초기화되지 않아 발생할 수 있는 문제를 예방할 수 있습니다.

3. **트랜잭션 적용**

   서비스 계층에서 @Transactional 어노테이션을 사용하여 트랜잭션을 관리합니다. 이를 통해 데이터 저장 작업이 모두 성공하거나 모두 롤백되도록 하여 데이터 일관성을 보장합니다.


## 결과

- **데이터 무결성 보장**: 연관된 컬렉션이 초기화되어 데이터 정상적으로 저장되고, DTO를 엔티티로 변환할 때 필드가 올바르게 초기화됩니다. 트랜잭션이 적용되어 데이터 저장 중 예외 발생 시 모든 작업이 롤백됩니다.
- 예외 처리 개선: NullPointerException과 같은 예외 발생 가능성이 줄어들고, 데이터 일관성이 유지됩니다.
- **안정성 향상**: 연관된 엔티티와 데이터 저장 작업이 안정적으로 처리되어 애플리케이션의 신뢰성이 높아졌습니다.

## 느낀점

- **컬렉션 필드와 DTO 초기화**: 이번 문제를 통해, 컬렉션 필드와 DTO에서 엔티티 변환 시 초기화가 중요하다는 점을 깨달았습니다. 적절한 초기화가 없으면 데이터 추가 작업에서 예외가 발생할 수 있음을 직접 경험했습니다.
- **트랜잭션 관리의 중요성**: 트랜잭션을 통해 데이터 저장의 일관성과 무결성을 보장할 수 있다는 점도 매우 중요하다는 것을 배웠습니다.
- **애플리케이션 설계의 안정성**: 작은 실수라도 데이터 무결성에 큰 영향을 미칠 수 있다는 점을 깨달았고, 이를 예방하기 위해 필드 초기화와 트랜잭션 관리를 항상 고려해야 한다는 점을 알게 되었습니다.